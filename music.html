<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸŽ¼ Elif Composer (Final Build)</title>
  <style>
    body {
      background: #000;
      color: #33ff33;
      font-family: 'Courier New', monospace;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    textarea, select, button, input {
      width: 100%;
      background: #111;
      color: #33ff33;
      border: 1px solid #33ff33;
      padding: 10px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }
    button:hover {
      background: #222;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    canvas {
      background: #111;
      margin-top: 20px;
      width: 100%;
      height: 100px;
    }
    .control-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    .control-row > * {
      flex: 1;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #33ff33;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .slider-container label {
      flex: 1;
    }
    .slider-container input {
      flex: 3;
      margin: 0;
    }
    .slider-container span {
      flex: 1;
      text-align: right;
    }
    #visualizer {
      border: 1px solid #33ff33;
    }
    .hidden {
      display: none;
    }
    .notification {
      padding: 10px;
      background-color: #222;
      border: 1px solid #33ff33;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/vexflow@1.2.93/releases/vexflow-min.js"></script>
  <script src="https://unpkg.com/tone@14.8.39/build/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/audio-buffer-to-wav/index.min.js"></script>
</head>
<body>
  <h2>ðŸŽ¼ Elif Composer (Final Build)</h2>
  <div id="startAudio" class="notification">Please click this message to initialize audio playback â–¶</div>
  <div class="control-row">
    <textarea id="notation" rows="10">{
  "treble": [
    { "note": "C5", "duration": "4n" },
    { "note": "E5", "duration": "8n" },
    { "note": "G5", "duration": "8n" },
    { "note": "A5", "duration": "2n" }
  ],
  "bass": [
    { "note": "C3", "duration": "1n" },
    { "note": "F2", "duration": "1n" }
  ]
}</textarea>
    <button onclick="renderScore()">â–¶ Render & Play</button>
  </div>
  <div id="sheet"></div>
  <script>
    const VF = Vex.Flow;
    let audioInitialized = false;

    document.getElementById("startAudio").addEventListener("click", function() {
      if (!audioInitialized) {
        Tone.start();
        audioInitialized = true;
        this.style.display = "none";
      }
    });

    function durationToBeats(d) {
      return { "1n": 4, "2n": 2, "4n": 1, "8n": 0.5 }[d] || 1;
    }

    function fillVoiceWithRests(part, totalBeats) {
      let current = part.reduce((sum, n) => sum + durationToBeats(n.duration), 0);
      while (current < totalBeats) {
        part.push({ note: "b4", duration: "4n" });
        current += 1;
      }
      return part;
    }

    function noteToVF(note) {
      const m = note.match(/([A-G][#b]?)(\d)/);
      return m ? `${m[1].toLowerCase()}/${m[2]}` : "b/4";
    }

    function parseScore() {
      try {
        const input = JSON.parse(document.getElementById("notation").value);
        if (!input.treble) input.treble = [];
        if (!input.bass) input.bass = [];
        return input;
      } catch (e) {
        alert("Invalid JSON input.");
        return { treble: [], bass: [] };
      }
    }

    function renderScore() {
      if (!audioInitialized) {
        Tone.start();
        audioInitialized = true;
        document.getElementById("startAudio").style.display = "none";
      }

      const score = parseScore();
      const sheet = document.getElementById("sheet");
      sheet.innerHTML = '';

      try {
        const renderer = new VF.Renderer(sheet, VF.Renderer.Backends.SVG);
        renderer.resize(900, 400);
        const context = renderer.getContext();

        const trebleStave = new VF.Stave(10, 40, 800).addClef("treble").addTimeSignature("4/4");
        const bassStave = new VF.Stave(10, 140, 800).addClef("bass").addTimeSignature("4/4");
        trebleStave.setContext(context).draw();
        bassStave.setContext(context).draw();

        const trebleBeats = score.treble.reduce((sum, n) => sum + durationToBeats(n.duration), 0);
        const bassBeats = score.bass.reduce((sum, n) => sum + durationToBeats(n.duration), 0);
        const maxBeats = Math.max(trebleBeats, bassBeats);

        const trebleFilled = fillVoiceWithRests([...score.treble], maxBeats);
        const bassFilled = fillVoiceWithRests([...score.bass], maxBeats);

        const trebleVoice = new VF.Voice({ num_beats: maxBeats, beat_value: 1 });
        const bassVoice = new VF.Voice({ num_beats: maxBeats, beat_value: 1 });

        const vfTreble = trebleFilled.map(n => new VF.StaveNote({ keys: [noteToVF(n.note)], duration: n.duration.replace('n', '') }));
        const vfBass = bassFilled.map(n => new VF.StaveNote({ keys: [noteToVF(n.note)], duration: n.duration.replace('n', '') }));

        trebleVoice.addTickables(vfTreble);
        bassVoice.addTickables(vfBass);

        new VF.Formatter().joinVoices([trebleVoice, bassVoice]).format([trebleVoice, bassVoice], 750);
        trebleVoice.draw(context, trebleStave);
        bassVoice.draw(context, bassStave);

        playNow(score);
      } catch (error) {
        console.error("Render error:", error);
        sheet.innerHTML = `<div class="notification">Error rendering score: ${error.message}</div>`;
      }
    }

    function playNow(score) {
      const inst = Tone.Synth;
      const synthT = new inst().toDestination();
      const synthB = new inst().toDestination();
      let t = Tone.now();
      score.treble.forEach(n => {
        synthT.triggerAttackRelease(n.note, n.duration, t);
        t += Tone.Time(n.duration).toSeconds();
      });
      t = Tone.now();
      score.bass.forEach(n => {
        synthB.triggerAttackRelease(n.note, n.duration, t);
        t += Tone.Time(n.duration).toSeconds();
      });
    }
  </script>
</body>
</html>









