<!DOCTYPE html>
<!--
ElifÂ Composer â€“ fixed build 22Â AprÂ 2025Â (AUDIO + VexFlow bugs resolved)
MITâ€‘licensed; uses VexFlowÂ 1.2.93, Tone.jsÂ 14.8Â (via CDN)
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸŽ¼Â ElifÂ Composer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{background:#000;color:#33ff33;font-family:"Courier New",monospace;padding:20px;max-width:900px;margin:0 auto}
  textarea,select,button,input{width:100%;background:#111;color:#33ff33;border:1px solid #33ff33;padding:10px;margin:10px 0;font-family:"Courier New",monospace}
  button:hover{background:#222;cursor:pointer}button:disabled{opacity:.5;cursor:not-allowed}
  canvas{background:#111;margin-top:20px;width:100%;height:100px}
  .control-row{display:flex;gap:10px;margin:10px 0}.control-row>*{flex:1}
  .slider-container{display:flex;align-items:center;gap:10px;margin:10px 0}
  .slider-container label{flex:1}.slider-container input{flex:3;margin:0}.slider-container span{flex:1;text-align:right}
  #visualizer{border:1px solid #33ff33}.notification{padding:10px;background:#222;border:1px solid #33ff33;margin:10px 0;border-radius:4px}.hidden{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/vexflow@1.2.93/releases/vexflow-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
</head>
<body>
<h2>ðŸŽ¼Â ElifÂ MusicÂ Composer</h2>

<div id="initBanner" class="notification">Click here once to enable audio â–¶</div>

<!-- --------------- Controls --------------- -->
<div class="control-row">
  <div>
    <label>Presets</label>
    <select id="presets">
      <option value="">--Â SelectÂ PresetÂ --</option>
      <option value="scale">CÂ MajorÂ Scale</option>
      <option value="chord">CÂ MajorÂ Chord</option>
      <option value="melody">SimpleÂ Melody</option>
    </select>
  </div>
  <div>
    <label>Instrument</label>
    <select id="instrument">
      <option>Synth</option><option>AMSynth</option><option>FMSynth</option>
      <option>PluckSynth</option><option>MetalSynth</option><option>MembraneSynth</option>
    </select>
  </div>
</div>

<div class="slider-container">
  <label>Tempo</label><input type="range" id="tempo" min="60" max="200" value="120">
  <span id="tempoVal">120Â BPM</span>
</div>

<div class="slider-container">
  <label>Reverb</label><input type="range" id="reverb" min="0" max="1" step="0.05" value="0">
  <span id="reverbVal">0</span>
</div>

<label>JSONÂ Score</label>
<textarea id="notation" rows="10">{
  "treble":[{"note":"C5","duration":"4n"},{"note":"E5","duration":"8n"},
            {"note":"G5","duration":"8n"},{"note":"A5","duration":"2n"}],
  "bass":[{"note":"C3","duration":"1n"},{"note":"F2","duration":"1n"}]
}</textarea>

<div class="control-row">
  <button id="renderBtn">â–¶Â RenderÂ &Â Play</button>
  <button id="exportBtn">ðŸ’¾Â ExportÂ WAV</button>
  <button id="addT">+Â AddÂ Treble</button>
  <button id="addB">+Â AddÂ Bass</button>
</div>

<div id="sheet"></div>
<canvas id="visualizer" width="850" height="100"></canvas>
<div id="status" class="notification hidden"></div>

<script type="module">
/* ---------------- Constants & helpers ---------------- */
const VF = Vex.Flow;

/* beat length in quarterâ€‘note units */
const DUR_TO_BEATS = { "1n":4, "2n":2, "4n":1, "8n":0.5, "16n":0.25 };

/* VexFlow duration code maps */
const NOTE_DUR = { "1n":"w",  "2n":"h",  "4n":"q",  "8n":"8",  "16n":"16" };
const REST_DUR = { "1n":"wr", "2n":"hr", "4n":"qr", "8n":"8r", "16n":"16r" };

const PRESETS = { /* unchanged â€“ same as before */ };
/* PRESETS object body omitted here for brevity â€“ keep your existing one */

/* -------- DOM refs -------- */
const txt        = document.getElementById("notation");
const sheetDiv   = document.getElementById("sheet");
const canvas     = document.getElementById("visualizer");
const ctx        = canvas.getContext("2d");
const tempoSl    = document.getElementById("tempo");
const revSl      = document.getElementById("reverb");
const tempoVal   = document.getElementById("tempoVal");
const revVal     = document.getElementById("reverbVal");
const statusDiv  = document.getElementById("status");
const initBanner = document.getElementById("initBanner");

/* -------- State -------- */
let latestScore = { treble:[], bass:[] };
let visualRAF   = null;
let analyser    = null;
let audioReady  = false;

/* -------- Utility -------- */
function beats(arr){ return arr.reduce((s,n)=>s + (DUR_TO_BEATS[n.duration]||1), 0); }

function rest(duration){ return { note:"b/4", duration:REST_DUR[duration] || "qr" }; }

/* Convert â€œC4â€ â†’ â€œc/4â€. If already contains â€œ/â€, return asâ€‘is. */
function noteToVF(note){
  if (note.includes("/")) return note;          // already in â€œkey/octaveâ€
  const m = note.match(/^([A-Ga-g])([b#]?)(\d)$/);
  if (!m) return "c/4";                        // fallback (shouldnâ€™t happen)
  return `${m[1].toLowerCase()}${m[2]}/${m[3]}`;
}

/* -------- Audio gating -------- */
initBanner.onclick = async () => {
  await Tone.start();
  audioReady = true;
  initBanner.remove();
};

/* -------- Score parsing -------- */
function getScore(){
  try{
    const s = JSON.parse(txt.value || "{}");
    s.treble = s.treble || [];
    s.bass   = s.bass   || [];
    if (!s.treble.length) s.treble.push({ note:"C4", duration:"4n" });
    if (!s.bass.length)   s.bass.push({ note:"C3", duration:"4n" });
    latestScore = JSON.parse(JSON.stringify(s));   // deepâ€‘copy cache
    return s;
  }catch(err){
    alert("Invalid JSON: " + err.message);
    throw err;
  }
}

/* -------- Sheet rendering -------- */
function renderSheet(score){
  sheetDiv.innerHTML = "";
  const width = Math.max(320, sheetDiv.clientWidth-20);

  const renderer = new VF.Renderer(sheetDiv, VF.Renderer.Backends.SVG);
  renderer.resize(width, 380);
  const vfCtx = renderer.getContext();

  const tStave = new VF.Stave(10, 40 , width-20).addClef("treble").addTimeSignature("4/4");
  const bStave = new VF.Stave(10, 180, width-20).addClef("bass")  .addTimeSignature("4/4");
  tStave.setContext(vfCtx).draw();
  bStave.setContext(vfCtx).draw();

  const total = Math.max(beats(score.treble), beats(score.bass));

  /* pad with rests until both voices align */
  while (beats(score.treble) < total) score.treble.push(rest("4n"));
  while (beats(score.bass)   < total) score.bass  .push(rest("4n"));

  const tVoice = new VF.Voice({ num_beats: total, beat_value:1 });
  const bVoice = new VF.Voice({ num_beats: total, beat_value:1 });

  const vfT = score.treble.map(n =>
      new VF.StaveNote({
        keys:[ noteToVF(n.note) ],
        duration: NOTE_DUR[n.duration] || REST_DUR[n.duration] || "q"
      }));

  const vfB = score.bass.map(n =>
      new VF.StaveNote({
        keys:[ noteToVF(n.note) ],
        duration: NOTE_DUR[n.duration] || REST_DUR[n.duration] || "q"
      }));

  tVoice.addTickables(vfT);
  bVoice.addTickables(vfB);
  new VF.Formatter().joinVoices([tVoice,bVoice]).format([tVoice,bVoice], width-80);
  tVoice.draw(vfCtx, tStave);
  bVoice.draw(vfCtx, bStave);
}

/* -------- Visualiser helpers -------- */
function clearVis(){ ctx.fillStyle="#111"; ctx.fillRect(0,0,canvas.width,canvas.height); }

function startVis(node){
  if (visualRAF) cancelAnimationFrame(visualRAF);
  analyser = new Tone.Analyser("fft", 32); node.connect(analyser);

  (function draw(){
    ctx.fillStyle="#111"; ctx.fillRect(0,0,canvas.width,canvas.height);
    const data = analyser.getValue();
    const bar  = canvas.width / data.length * 0.8;
    let x = 0;
    for(const d of data){
      const h = Math.max(4, d*100+100);
      ctx.fillStyle=`rgb(51,${h+80|0},51)`;
      ctx.fillRect(x, canvas.height-h, bar, h);
      x += bar + 1;
    }
    visualRAF = requestAnimationFrame(draw);
  })();
}
function stopVis(){ if(visualRAF)cancelAnimationFrame(visualRAF); if(analyser){ analyser.dispose(); analyser=null;} clearVis(); }

/* -------- Playback -------- */
async function play(score){
  if(!audioReady){ alert("Click the banner first to enable audio."); return; }

  stopVis();
  Tone.Transport.stop(); Tone.Transport.cancel(0);

  const tempo = +tempoSl.value;
  Tone.Transport.bpm.value = tempo;

  const Inst = Tone[ document.getElementById("instrument").value ] || Tone.Synth;
  const synthT = new Inst();
  const synthB = new Inst();
  const reverb = new Tone.Reverb(1.8).toDestination();
  reverb.wet.value = +revSl.value;
  synthT.connect(reverb); synthB.connect(reverb);

  let t = 0;
  score.treble.forEach(n => { synthT.triggerAttackRelease(n.note, n.duration, t); t += Tone.Time(n.duration).toSeconds(); });
  t = 0;
  score.bass.forEach  (n => { synthB.triggerAttackRelease(n.note, n.duration, t); t += Tone.Time(n.duration).toSeconds(); });

  startVis(new Tone.Gain().fan(synthT, synthB)); // visualiser tap
  Tone.Transport.start();
}

/* -------- WAV export -------- */
async function exportWav(){
  if(!audioReady){ alert("Enable audio first."); return; }

  const btn = document.getElementById("exportBtn");
  btn.disabled = true; btn.textContent = "ðŸ’¾Â Exportingâ€¦";
  statusDiv.classList.remove("hidden"); statusDiv.textContent = "Rendering offlineâ€¦";

  const score = latestScore;
  const tempo = +tempoSl.value;
  const totalTicks = Math.max(beats(score.treble), beats(score.bass)) * Tone.Time("4n").toTicks();
  const durSec = Tone.Ticks(totalTicks).toSeconds() + 1;

  const Inst = Tone[ document.getElementById("instrument").value ] || Tone.Synth;

  const buffer = await Tone.Offline(({transport})=>{
    transport.bpm.value = tempo;
    const rev = new Tone.Reverb(1.8).toDestination();
    rev.wet.value = +revSl.value;

    const tSynth=new Inst().connect(rev);
    const bSynth=new Inst().connect(rev);

    let t=0; score.treble.forEach(n=>{ tSynth.triggerAttackRelease(n.note, n.duration, t); t += Tone.Time(n.duration).toSeconds(); });
    t=0; score.bass.forEach(n=>{ bSynth.triggerAttackRelease(n.note, n.duration, t); t += Tone.Time(n.duration).toSeconds(); });

    transport.start();
  }, durSec);

  statusDiv.textContent = "Encoding WAVâ€¦";
  const {default:toWav} = await import('https://cdn.jsdelivr.net/npm/audio-buffer-to-wav@1.4.0/index.js');
  const wavBlob = new Blob([ toWav(buffer.get()) ], {type:"audio/wav"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(wavBlob); a.download = "elif_song.wav"; a.click();
  statusDiv.textContent = "Done âœ“";
  setTimeout(()=>statusDiv.classList.add("hidden"),3000);
  btn.disabled = false; btn.textContent = "ðŸ’¾Â ExportÂ WAV";
}

/* -------- UI bindings -------- */
tempoSl.oninput = () => tempoVal.textContent = tempoSl.value + "Â BPM";
revSl  .oninput = () => revVal.textContent   = revSl.value;

document.getElementById("presets").onchange = e=>{
  const p = PRESETS[e.target.value]; if(!p) return;
  txt.value = JSON.stringify(p, null, 2);
  renderSheet(JSON.parse(JSON.stringify(p)));
};

document.getElementById("renderBtn").onclick = ()=>{ const s=getScore(); renderSheet(JSON.parse(JSON.stringify(s))); play(s); };
document.getElementById("exportBtn").onclick = exportWav;

document.getElementById("addT").onclick = ()=>{ const s=getScore(); s.treble.push({note:"C5",duration:"4n"}); txt.value=JSON.stringify(s,null,2); renderSheet(s); };
document.getElementById("addB").onclick = ()=>{ const s=getScore(); s.bass  .push({note:"C3",duration:"4n"}); txt.value=JSON.stringify(s,null,2); renderSheet(s); };

/* Shortcuts */
document.addEventListener("keydown",e=>{
  if(e.code==="Space" && e.target!==txt){ e.preventDefault(); document.getElementById("renderBtn").click(); }
  if(e.code==="KeyS" && e.ctrlKey     ){ e.preventDefault(); document.getElementById("exportBtn").click(); }
});

/* First paint */
renderSheet(getScore()); clearVis();
</script>

</body>
</html>
