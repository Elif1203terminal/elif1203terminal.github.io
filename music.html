<!DOCTYPE html>
<!--
Elif Composer â€“ fixed build 22Â AprÂ 2025
MITâ€‘licensed; uses VexFlow, Tone.js, audioâ€‘bufferâ€‘toâ€‘wav
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸŽ¼Â ElifÂ Composer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{background:#000;color:#33ff33;font-family:"Courier New",monospace;padding:20px;max-width:900px;margin:0 auto}
  textarea,select,button,input{width:100%;background:#111;color:#33ff33;border:1px solid #33ff33;padding:10px;margin:10px 0;font-family:"Courier New",monospace}
  button:hover{background:#222;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  canvas{background:#111;margin-top:20px;width:100%;height:100px}
  .control-row{display:flex;gap:10px;margin:10px 0}
  .control-row>*{flex:1}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tooltiptext{visibility:hidden;width:140px;background:#333;color:#33ff33;text-align:center;border-radius:6px;padding:5px;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-70px;opacity:0;transition:.3s}
  .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
  .slider-container{display:flex;align-items:center;gap:10px;margin:10px 0}
  .slider-container label{flex:1}
  .slider-container input{flex:3;margin:0}
  .slider-container span{flex:1;text-align:right}
  #visualizer{border:1px solid #33ff33}
  .notification{padding:10px;background:#222;border:1px solid #33ff33;margin:10px 0;border-radius:4px}
  .hidden{display:none}
</style>
<!-- UMD builds (globals) -->
<script src="https://cdn.jsdelivr.net/npm/vexflow@1.2.93/releases/vexflow-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
</head>
<body>
<h2>ðŸŽ¼Â ElifÂ MusicÂ Composer</h2>

<div id="startAudio" class="notification">Click here once to initialize audio â–¶</div>

<div class="control-row">
  <div class="tooltip" style="flex:1.1">
    <label>Presets</label><span class="tooltiptext">Load example score</span>
    <select id="presets">
      <option value="">--Â SelectÂ PresetÂ --</option>
      <option value="scale">CÂ MajorÂ Scale</option>
      <option value="chord">CÂ MajorÂ Chord</option>
      <option value="melody">SimpleÂ Melody</option>
    </select>
  </div>
  <div class="tooltip" style="flex:0.9">
    <label>Instrument</label><span class="tooltiptext">Tone.js synth family</span>
    <select id="instrument">
      <option>Synth</option><option>AMSynth</option><option>FMSynth</option>
      <option>PluckSynth</option><option>MetalSynth</option><option>MembraneSynth</option>
    </select>
  </div>
</div>

<div class="slider-container">
  <label>Tempo</label>
  <input type="range" id="tempo" min="60" max="200" step="1" value="120">
  <span id="tempoVal">120Â BPM</span>
</div>

<div class="slider-container">
  <label>Reverb</label>
  <input type="range" id="reverb" min="0" max="1" step="0.05" value="0">
  <span id="reverbVal">0</span>
</div>

<label>JSONÂ Score</label>
<textarea id="notation" rows="10">{
  "treble":[{"note":"C5","duration":"4n"},{"note":"E5","duration":"8n"},
            {"note":"G5","duration":"8n"},{"note":"A5","duration":"2n"}],
  "bass":[{"note":"C3","duration":"1n"},{"note":"F2","duration":"1n"}]
}</textarea>

<div class="control-row">
  <button id="renderBtn" class="tooltip"><span class="tooltiptext">Space</span>â–¶Â RenderÂ &Â Play</button>
  <button id="exportBtn" class="tooltip"><span class="tooltiptext">CtrlÂ +Â S</span>ðŸ’¾Â ExportÂ WAV</button>
  <button id="addT">+Â AddÂ Treble</button>
  <button id="addB">+Â AddÂ Bass</button>
</div>

<div id="sheet"></div>
<canvas id="visualizer" width="850" height="100"></canvas>
<div id="status" class="notification hidden"></div>

<script type="module">
/* ---------- Globals ---------- */
const VF=Vex.Flow;
let latestScore={treble:[],bass:[]}, visualLoop=null, analyser=null, audioReady=false;

/* ---------- Helper maps ---------- */
const DUR_TO_BEATS={"1n":4,"2n":2,"4n":1,"8n":0.5,"16n":0.25};
const PRESETS={
  scale:{treble:["C4","D4","E4","F4","G4","A4","B4","C5"].map(n=>({note:n,duration:"4n"})),
         bass:[{note:"C3",duration:"1n"},{note:"G2",duration:"1n"}]},
  chord:{treble:[{note:"C4",duration:"1n"},{note:"E4",duration:"1n"},{note:"G4",duration:"1n"}],
         bass:[{note:"C3",duration:"1n"}]},
  melody:{treble:[{note:"C4",duration:"4n"},{note:"E4",duration:"4n"},{note:"G4",duration:"4n"},
                  {note:"C5",duration:"4n"},{note:"B4",duration:"4n"},{note:"A4",duration:"4n"},
                  {note:"G4",duration:"2n"}],
          bass:[{note:"C3",duration:"2n"},{note:"G2",duration:"2n"},
                {note:"F2",duration:"2n"},{note:"G2",duration:"2n"}]}
};

/* ---------- DOM refs ---------- */
const txt=document.getElementById("notation");
const sheetDiv=document.getElementById("sheet");
const canvas=document.getElementById("visualizer");
const ctx=canvas.getContext("2d");
const tempoSlider=document.getElementById("tempo");
const reverbSlider=document.getElementById("reverb");
const tempoVal=document.getElementById("tempoVal");
const reverbVal=document.getElementById("reverbVal");
const statusDiv=document.getElementById("status");

/* ---------- Audio bootstrap ---------- */
document.getElementById("startAudio").onclick=async e=>{
  await Tone.start();audioReady=true;e.target.remove();
};

/* ---------- Utility ---------- */
function beats(arr){return arr.reduce((s,n)=>s+(DUR_TO_BEATS[n.duration]||1),0);}
function noteToVF(note){const m=note.match(/^([A-G][b#]?)(\d)$/);return m?`${m[1].toLowerCase()}/${m[2]}`:"b/4";}
function ensureRests(part,total){
  let cur=beats(part);
  while(cur<total){part.push({note:"b4",duration:"4n"});cur+=1;}
}
/* ---------- Parse score ---------- */
function getScore(){
  try{const s=JSON.parse(txt.value||"{}");
      s.treble=s.treble||[];s.bass=s.bass||[];
      if(!s.treble.length)s.treble.push({note:"C4",duration:"4n"});
      if(!s.bass.length)s.bass.push({note:"C3",duration:"4n"});
      latestScore=s;return s;
  }catch(e){alert("Invalid JSON: "+e.message);throw e;}
}

/* ---------- Render sheet ---------- */
function renderSheet(score){
  sheetDiv.innerHTML="";
  const renderer=new VF.Renderer(sheetDiv,VF.Renderer.Backends.SVG);
  renderer.resize(sheetDiv.clientWidth,400);
  const ctxR=renderer.getContext();

  const tStave=new VF.Stave(10,40,renderer.getContext().svg.offsetWidth-20)
                 .addClef("treble").addTimeSignature("4/4");
  const bStave=new VF.Stave(10,160,renderer.getContext().svg.offsetWidth-20)
                 .addClef("bass").addTimeSignature("4/4");
  tStave.setContext(ctxR).draw();bStave.setContext(ctxR).draw();

  const maxB=Math.max(beats(score.treble),beats(score.bass));
  ensureRests(score.treble,maxB);ensureRests(score.bass,maxB);

  const tVoice=new VF.Voice({num_beats:maxB,beat_value:1});
  const bVoice=new VF.Voice({num_beats:maxB,beat_value:1});

  const vfT=score.treble.map(n=>new VF.StaveNote({
      keys:[noteToVF(n.note)],duration:n.duration.replace("n","")
    }));
  const vfB=score.bass.map(n=>new VF.StaveNote({
      keys:[noteToVF(n.note)],duration:n.duration.replace("n","")
    }));

  tVoice.addTickables(vfT);bVoice.addTickables(vfB);
  new VF.Formatter().joinVoices([tVoice,bVoice]).format([tVoice,bVoice], tStave.getWidth()-50);
  tVoice.draw(ctxR,tStave);bVoice.draw(ctxR,bStave);
}

/* ---------- Play ---------- */
function clearVisual(){
  ctx.fillStyle="#111";ctx.fillRect(0,0,canvas.width,canvas.height);
}
function startVisualizer(node){
  if(visualLoop)cancelAnimationFrame(visualLoop);
  const fft=analyser=new Tone.Analyser("fft",32);node.connect(fft);
  function draw(){
    ctx.fillStyle="#111";ctx.fillRect(0,0,canvas.width,canvas.height);
    const data=fft.getValue();const barW=canvas.width/data.length*0.8;
    let x=0;
    for(let d of data){
      const h=Math.max(4,d*100+100);
      ctx.fillStyle=`rgb(51,${Math.floor(h+100)},51)`;
      ctx.fillRect(x,canvas.height-h,barW,h);x+=barW+1;
    }
    visualLoop=requestAnimationFrame(draw);
  }
  draw();
}
function stopVisualizer(){
  if(visualLoop)cancelAnimationFrame(visualLoop);
  if(analyser){analyser.dispose();analyser=null;}
  clearVisual();
}
async function play(score){
  if(!audioReady){alert("Click the initialization banner first.");return;}
  stopVisualizer();
  Tone.Transport.stop();Tone.Transport.cancel(0);

  const Inst=Tone[document.getElementById("instrument").value]||Tone.Synth;
  const revWet=parseFloat(reverbSlider.value);
  const tempo=parseInt(tempoSlider.value);
  Tone.Transport.bpm.value=tempo;

  const reverb=new Tone.Reverb(1.5).toDestination();reverb.wet.value=revWet;
  const tSynth=new Inst().connect(reverb);
  const bSynth=new Inst().connect(reverb);

  let tTime=0;score.treble.forEach(n=>{
    tSynth.triggerAttackRelease(n.note,n.duration,tTime);tTime+=Tone.Time(n.duration).toSeconds();});
  let bTime=0;score.bass.forEach(n=>{
    bSynth.triggerAttackRelease(n.note,n.duration,bTime);bTime+=Tone.Time(n.duration).toSeconds();});

  startVisualizer(new Tone.Gain().fan(tSynth,bSynth)); // node feeding analyser
  Tone.Transport.start();
}

/* ---------- Export ---------- */
async function exportWav(){
  if(!audioReady){alert("Initialize audio first.");return;}
  const btn=document.getElementById("exportBtn");btn.disabled=true;btn.textContent="ðŸ’¾Â Exportingâ€¦";
  statusDiv.classList.remove("hidden");statusDiv.textContent="Rendering offlineâ€¦";
  const score=latestScore;const tempo=parseInt(tempoSlider.value);
  const revWet=parseFloat(reverbSlider.value);
  const Inst=Tone[document.getElementById("instrument").value]||Tone.Synth;

  const dur=beats(score.treble)+2; // seconds (approx)
  const buffer=await Tone.Offline(({transport})=>{
    const reverb=new Tone.Reverb(1.5).toDestination();reverb.wet.value=revWet;
    const tSynth=new Inst().connect(reverb);
    const bSynth=new Inst().connect(reverb);
    transport.bpm.value=tempo;
    let t=0;score.treble.forEach(n=>{tSynth.triggerAttackRelease(n.note,n.duration,t);
                                      t+=Tone.Time(n.duration).toSeconds();});
    t=0;score.bass.forEach(n=>{bSynth.triggerAttackRelease(n.note,n.duration,t);
                               t+=Tone.Time(n.duration).toSeconds();});
    transport.start();
  },dur);

  statusDiv.textContent="Encoding WAVâ€¦";
  const {default:toWav}=await import('https://cdn.jsdelivr.net/npm/audio-buffer-to-wav@1.4.0/index.js');
  const wavBlob=new Blob([toWav(buffer.get())],{type:"audio/wav"});
  const a=document.createElement("a");a.href=URL.createObjectURL(wavBlob);a.download="elif_song.wav";a.click();
  statusDiv.textContent="Done âœ“";setTimeout(()=>statusDiv.classList.add("hidden"),3000);
  btn.disabled=false;btn.textContent="ðŸ’¾Â ExportÂ WAV";
}

/* ---------- UI bindings ---------- */
tempoSlider.oninput=()=>tempoVal.textContent=tempoSlider.value+"Â BPM";
reverbSlider.oninput=()=>reverbVal.textContent=reverbSlider.value;
document.getElementById("presets").onchange=e=>{
  const p=PRESETS[e.target.value];if(!p)return;
  txt.value=JSON.stringify(p,null,2);renderSheet(p);play(p);
};
document.getElementById("renderBtn").onclick=()=>{const s=getScore();renderSheet(JSON.parse(JSON.stringify(s)));play(s);};
document.getElementById("exportBtn").onclick=exportWav;
document.getElementById("addT").onclick=()=>{const s=getScore();s.treble.push({note:"C5",duration:"4n"});
                                             txt.value=JSON.stringify(s,null,2);renderSheet(s);};
document.getElementById("addB").onclick=()=>{const s=getScore();s.bass.push({note:"C3",duration:"4n"});
                                             txt.value=JSON.stringify(s,null,2);renderSheet(s);};
/* Shortcuts */
document.addEventListener("keydown",e=>{
  if(e.code==="Space"&&e.target!==txt){e.preventDefault();document.getElementById("renderBtn").click();}
  if(e.code==="KeyS"&&e.ctrlKey){e.preventDefault();document.getElementById("exportBtn").click();}
});
/* First paint */
renderSheet(getScore());
clearVisual();
</script>
</body>
</html>
